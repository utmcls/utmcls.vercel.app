---
import BaseLayout from '../layouts/BaseLayout.astro';
import { reader } from '../lib/keystatic-reader';
import { renderMarkdocToHtml, renderMarkdocValueToHtml } from '../lib/render-markdoc';
import { toAbsoluteHref } from '../lib/url';

const opts = { resolveLinkedFiles: true as const };
const [hero, cta, footer, eventsList, teamList] = await Promise.all([
  reader.singletons.hero.read(opts),
  reader.singletons.cta.read(opts),
  reader.singletons.footer.read(opts),
  reader.collections.events.all(opts),
  reader.collections.team.all(opts),
]);

/** Keystatic returns content fields as string, () => Promise<string>, or (with resolveLinkedFiles) { node } (Markdoc AST). */
async function getMarkdocHtml(value: unknown): Promise<string> {
  if (value == null) return '';
  if (typeof value === 'object' && value !== null && 'node' in value) return renderMarkdocValueToHtml(value);
  if (typeof value === 'string') return value ? renderMarkdocToHtml(value) : '';
  if (typeof value === 'function') {
    const result = await (value as () => Promise<unknown>)();
    return typeof result === 'string' ? renderMarkdocToHtml(result) : (result && typeof result === 'object' && 'node' in result ? renderMarkdocValueToHtml(result) : '');
  }
  return '';
}

const ctaBodyHtml = await getMarkdocHtml(cta?.body);

const materialIconStyle = "font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 48";
const materialIconStyleSm = "font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24";
---

<BaseLayout title="UTM CLS">
  <main class="flex flex-col min-h-screen">
    <!-- Hero -->
    <section class="px-5 py-16 md:py-24">
      <div class="mx-auto flex max-w-6xl flex-col gap-12 md:flex-row md:items-center md:gap-16">
        <div class="flex-1">
          {hero?.statusLabel && (
            <div class="mb-6 inline-flex items-center gap-2 rounded-lg border border-border bg-muted px-3 py-1.5 text-sm text-foreground">
              {hero.statusDot && <span class="size-2 rounded-full bg-tag-lecture" aria-hidden />}
              <span>Status: {hero.statusLabel}</span>
            </div>
          )}
          <h1 class="mb-4 text-4xl font-bold leading-tight tracking-tight text-primary md:text-5xl">
            UTM Computational <span class="text-accent">Linguistics Society</span>
          </h1>
          <p class="mb-8 max-w-xl text-lg text-muted-foreground">
            We are an undergraduate-run society exploring the intersection of language and computing. Join us for guest lectures, workshops, and research.
          </p>
          <div class="flex flex-wrap gap-4">
            {hero?.primaryButtonUrl && (
              <a href={toAbsoluteHref(hero.primaryButtonUrl)} class="inline-flex items-center justify-center rounded-lg bg-accent px-6 py-3 font-medium text-accent-foreground hover:opacity-90">
                {hero.primaryButtonLabel ?? 'Become a Member'} →
              </a>
            )}
            {hero?.secondaryButtonUrl && (
              <a href={toAbsoluteHref(hero.secondaryButtonUrl)} class="inline-flex items-center justify-center rounded-lg border border-border bg-background px-6 py-3 font-medium text-foreground hover:bg-muted">
                {hero.secondaryButtonLabel ?? 'View Upcoming Events'}
              </a>
            )}
          </div>
        </div>
        <div class="flex-1">
          <div class="overflow-hidden rounded-lg border border-border bg-[#1e293b] shadow-card">
            <div class="flex items-center gap-2 border-b border-white/10 px-4 py-2">
              <span class="size-3 rounded-full bg-red-500/80" />
              <span class="size-3 rounded-full bg-amber-500/80" />
              <span class="size-3 rounded-full bg-emerald-500/80" />
              <span class="ml-2 text-xs text-slate-400">utmcls_mission.py</span>
              <span class="ml-auto text-xs text-slate-500">Python 3.11</span>
            </div>
            <pre class="overflow-x-auto p-4 font-mono text-sm leading-relaxed text-slate-200"><code>{`class UTMCLS:
  def __init__(self):
    self.community = ""
    self.focus = [ "Comp Ling" ]

  def goals(self):
    # Bridging the gap between fields
    return "Connect & Innovate"

  # Join the society today
  society = UTMCLS()`}</code></pre>
          </div>
        </div>
      </div>
    </section>

    <!-- What We Do -->
    <section id="activities" class="border-t border-border bg-muted/30 px-5 py-16">
      <div class="mx-auto max-w-6xl">
        <h2 class="mb-4 text-3xl font-bold text-primary">## What We Do</h2>
        <p class="mb-10 max-w-2xl text-muted-foreground">
          We represent the interests of students enrolled in UTM&apos;s certificate in computational linguistics. We strive to build a community for students to connect, code, hang out and cultivate an interest in compling!
        </p>
        <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-4">
          <article class="rounded-xl border border-border bg-card p-6 shadow-card">
            <div class="mb-4 flex items-center justify-center text-accent" aria-hidden>
              <span class="material-symbols-outlined text-[3rem]" style={materialIconStyle}>code</span>
            </div>
            <h3 class="mb-2 font-semibold text-foreground">Coding Workshops</h3>
            <p class="mb-4 text-sm text-muted-foreground">Hands-on sessions with Python, NLTK, spaCy, and Hugging Face transformers suitable for all skill levels.</p>
            <code class="block text-xs text-muted-foreground">&gt; import torch</code>
          </article>
          <article class="rounded-xl border border-border bg-card p-6 shadow-card">
            <div class="mb-4 flex items-center justify-center text-accent" aria-hidden>
              <span class="material-symbols-outlined text-[3rem]" style={materialIconStyle}>biotech</span>
            </div>
            <h3 class="mb-2 font-semibold text-foreground">Research Projects</h3>
            <p class="mb-4 text-sm text-muted-foreground">Collaborate on semester-long research projects. Opportunities to work with graduate mentors.</p>
            <code class="block text-xs text-muted-foreground">&gt; model.train()</code>
          </article>
          <article class="rounded-xl border border-border bg-card p-6 shadow-card">
            <div class="mb-4 flex items-center justify-center text-accent" aria-hidden>
              <span class="material-symbols-outlined text-[3rem]" style={materialIconStyle}>podium</span>
            </div>
            <h3 class="mb-2 font-semibold text-foreground">Guest Lectures</h3>
            <p class="mb-4 text-sm text-muted-foreground">Learn from graduate students and researchers about their latest work in Computational Linguistics.</p>
            <code class="block text-xs text-muted-foreground">&gt; speaker.listen()</code>
          </article>
          <article class="rounded-xl border border-border bg-card p-6 shadow-card">
            <div class="mb-4 flex items-center justify-center text-accent" aria-hidden>
              <span class="material-symbols-outlined text-[3rem]" style={materialIconStyle}>work</span>
            </div>
            <h3 class="mb-2 font-semibold text-foreground">Career Development</h3>
            <p class="mb-4 text-sm text-muted-foreground">Resume reviews, interview prep for AI roles, and networking with alumni.</p>
            <code class="block text-xs text-muted-foreground">&gt; job.apply()</code>
          </article>
        </div>
      </div>
    </section>

    <!-- Upcoming Events -->
    <section id="events" class="border-t border-border px-5 py-16">
      <div class="mx-auto max-w-6xl">
        <p class="mb-8 text-muted-foreground">Join our workshops, lectures, and socials.</p>
        <div class="overflow-x-auto rounded-xl border border-border">
          <table class="w-full text-left text-sm">
            <thead class="border-b border-border bg-muted/50">
              <tr>
                <th class="px-5 py-4 font-semibold text-foreground">DATE & TIME</th>
                <th class="px-5 py-4 font-semibold text-foreground">DETAILS</th>
                <th class="px-5 py-4 font-semibold text-foreground">TYPE</th>
                <th class="px-5 py-4 font-semibold text-foreground">LINK</th>
              </tr>
            </thead>
            <tbody>
              {eventsList?.map(({ slug, entry }) => (
                <tr class="border-b border-border last:border-0">
                  <td class="px-5 py-4">
                    {entry.datetime ? (() => {
                      const start = new Date(entry.datetime);
                      const end = entry.endDatetime ? new Date(entry.endDatetime) : null;
                      const timeOpts = { hour: 'numeric', minute: '2-digit', hour12: true } as const;
                      return (
                        <>
                          <span class="font-medium text-accent">
                            {start.toLocaleDateString('en-CA', { month: 'short', day: 'numeric' })}
                          </span>
                          <span class="mt-1 block text-xs text-muted-foreground">
                            {end
                              ? `${start.toLocaleTimeString('en-CA', timeOpts)} – ${end.toLocaleTimeString('en-CA', timeOpts)}`
                              : start.toLocaleTimeString('en-CA', timeOpts)}
                          </span>
                        </>
                      );
                    })() : '—'}
                  </td>
                  <td class="px-5 py-4">
                    <span class="font-semibold text-foreground">{entry.title}</span>
                    {entry.details && <span class="mt-1 block text-muted-foreground">{entry.details}</span>}
                  </td>
                  <td class="px-5 py-4">
                    <span class="inline-flex rounded-full px-2.5 py-1 text-xs font-medium bg-muted text-muted-foreground border border-border">
                      {entry.type ?? '—'}
                    </span>
                  </td>
                  <td class="px-5 py-4">
                    {entry.registerUrl ? (
                      <a href={toAbsoluteHref(entry.registerUrl)} class="inline-flex rounded-lg border border-accent bg-transparent px-4 py-2 text-sm font-medium text-accent hover:bg-accent/10">
                        {entry.linkLabel ?? 'Link'}
                      </a>
                    ) : (
                      '—'
                    )}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
        {(!eventsList || eventsList.length === 0) && (
          <p class="mt-4 text-muted-foreground">No upcoming events. Check back later.</p>
        )}
      </div>
    </section>

    <!-- Ready to get involved? -->
    <section id="media" class="border-t border-border bg-muted/30 px-5 py-16 text-center">
      <div class="mx-auto max-w-2xl">
        <h2 class="mb-4 text-2xl font-bold text-foreground">Ready to get involved?</h2>
        {ctaBodyHtml ? (
          <div class="prose prose-slate max-w-none text-muted-foreground mx-auto mb-8" set:html={ctaBodyHtml} />
        ) : (
          <p class="mb-8 text-muted-foreground">
            Follow our social media page to stay up to date with the latest workshops, guest lectures, and research opportunities.
          </p>
        )}
        {cta?.buttonUrl && (
          <a href={toAbsoluteHref(cta.buttonUrl)} class="inline-flex items-center justify-center rounded-lg bg-primary px-6 py-3 font-medium text-primary-foreground hover:opacity-90">
            {cta.buttonLabel ?? 'Our Links'}
          </a>
        )}
      </div>
    </section>

    <!-- Our Team -->
    <section id="team" class="border-t border-border px-5 py-16">
      <div class="mx-auto max-w-6xl">
        <h2 class="mb-4 text-3xl font-bold text-primary">## Our Team</h2>
        <p class="mb-10 text-muted-foreground">
          The representatives of our organization. Important information regarding club organization can be found on our <a class="text-accent" href={toAbsoluteHref('https://sop.utoronto.ca/wp-content/uploads/2025/11/utm-computational-linguistics-society-utmcls-2025-11-16.pdf')}>constitution</a>.
        </p>
        {teamList && teamList.length > 0 ? (
          <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-4 justify-items-center">
            {teamList.map(({ slug, entry }) => (
              <article class="w-full max-w-[320px] rounded-xl border border-border bg-card p-0 shadow-card overflow-hidden">
                {entry.image ? (
                  <img src={entry.image} alt={entry.name ?? 'Team member'} class="aspect-[4/3] w-full border-b border-border object-cover" />
                ) : (
                  <div class="aspect-[4/3] w-full border-b border-border bg-muted" aria-hidden />
                )}
                <div class="p-6 text-center">
                  <h3 class="font-semibold text-foreground">{entry.name ?? 'Firstname Lastname'}</h3>
                  <p class="mt-1 text-sm text-muted-foreground">{entry.role ?? 'Role'}</p>
                  <p class="mt-2 text-sm text-muted-foreground">{entry.description ?? 'Description'}</p>
                  <div class="mt-4 flex justify-center items-center gap-4 text-accent">
                    {entry.linkedin && (
                      <a href={toAbsoluteHref(entry.linkedin)} class="inline-flex items-center justify-center size-8 hover:opacity-80" aria-label="LinkedIn">
                        <i class="fa-brands fa-linkedin text-xl leading-none" aria-hidden />
                      </a>
                    )}
                    {entry.email && (
                      <a href={`mailto:${entry.email}`} class="inline-flex items-center justify-center size-8 hover:opacity-80" aria-label="Email">
                        <span class="material-symbols-outlined text-[1.25rem] leading-none" style={materialIconStyleSm} aria-hidden>mail</span>
                      </a>
                    )}
                  </div>
                </div>
              </article>
            ))}
          </div>
        ) : (
          <p class="text-muted-foreground">No team members yet.</p>
        )}
      </div>
    </section>

    <!-- Footer: dark gray main area, blue strip only at bottom -->
    <footer class="mt-auto bg-footer text-footer-foreground">
      <div class="mx-auto max-w-6xl px-5 py-12">
        <div class="flex flex-col items-center gap-10 md:flex-row md:items-start md:justify-center md:gap-16">
          <div class="text-center md:text-left md:max-w-xs">
            <p class="text-lg font-semibold">UTMCLS</p>
            <p class="mt-2 text-sm text-footer-foreground-muted">{footer?.tagline ?? 'UTM Computational Linguistics Society. Run by students, for students.'}</p>
            <div class="mt-4 flex justify-center gap-4 md:justify-start text-footer-foreground-muted">
              <a href="https://www.instagram.com/utmcls/" class="hover:text-footer-foreground text-xl" aria-label="Instagram">
                <i class="fa-brands fa-instagram" aria-hidden />
              </a>
              <a href="mailto:utm.cls@studentorg.utoronto.ca" class="hover:text-footer-foreground" aria-label="Email">
                <span class="material-symbols-outlined text-[1.25rem] align-middle" style={materialIconStyleSm} aria-hidden>mail</span>
              </a>
            </div>
          </div>
          <div class="text-center md:text-left">
            <p class="font-semibold text-sm">Resources</p>
            <ul class="mt-2 space-y-1 text-sm text-footer-foreground-muted">
              {footer?.resourceLinks && footer.resourceLinks.length > 0 ? (
                footer.resourceLinks.map((link) => (
                  <li><a href={toAbsoluteHref(link.href)} class="hover:text-footer-foreground">{link.label}</a></li>
                ))
              ) : (
                <>
                  <li><a href="/datasets" class="hover:text-footer-foreground">datasets/</a></li>
                  <li><a href="/papers" class="hover:text-footer-foreground">papers/</a></li>
                  <li><a href="/slides" class="hover:text-footer-foreground">slides/</a></li>
                </>
              )}
            </ul>
          </div>
        </div>
      </div>
      <div class="flex flex-wrap items-center justify-between gap-4 bg-footer-strip px-5 py-3 text-sm text-footer-strip-foreground">
        <span>Made with Astro</span>
        <span>©{new Date().getFullYear()} UTMCLS</span>
      </div>
    </footer>
  </main>
</BaseLayout>
